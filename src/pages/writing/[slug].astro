---
import { getCollection, getEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { createPageTitle } from "../../utils/siteConfig";

export async function getStaticPaths() {
    const writingEntries = await getCollection("writing");
    return writingEntries.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const pageTitle = createPageTitle(entry.data.title);
const pageDescription =
    entry.data.summary || `Read "${entry.data.title}" by Hanif Carroll`;
const canonicalURL =
    entry.data.canonical || `https://hanifcarroll.com/writing/${entry.slug}/`;

// Format date for display
const formatDate = (dateString: string) => {
    const date = new Date(dateString);
    return date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
    });
};

// Get related posts by overlapping tags
const allPosts = await getCollection("writing");
const relatedPosts = allPosts
    .filter(
        (post) =>
            post.slug !== entry.slug &&
            post.data.tags.some((tag) => entry.data.tags.includes(tag))
    )
    .sort(
        (a, b) =>
            new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
    )
    .slice(0, 3);
---

<BaseLayout title={pageTitle} description={pageDescription}>
    <link slot="head" rel="canonical" href={canonicalURL} />

    <!-- Article Container -->
    <article class="bg-white">
        <!-- Article Header -->
        <header class="bg-gradient-to-b from-gray-50 to-white border-b border-gray-100">
            <div class="container max-w-3xl mx-auto py-16 px-6 md:py-20 lg:py-24">
                <div class="text-center">
                    <time
                        class="inline-block text-sm font-medium text-accent-600 uppercase tracking-wider mb-6"
                    >
                        {formatDate(entry.data.date)}
                    </time>
                    <h1
                        class="text-4xl md:text-5xl lg:text-6xl font-light tracking-tight leading-[1.1] text-gray-900 mb-6"
                    >
                        {entry.data.title}
                    </h1>
                    {
                        entry.data.summary && (
                            <p class="text-lg md:text-xl font-light leading-relaxed text-gray-600 max-w-2xl mx-auto">
                                {entry.data.summary}
                            </p>
                        )
                    }
                </div>
            </div>
        </header>

        <!-- Article Body -->
        <div class="container max-w-3xl mx-auto px-6 py-12 md:py-16">
            <!-- Article Content -->
            <div class="article-content">
                <Content />
            </div>

            <!-- Subscribe CTA -->
            <div
                class="mt-20 p-12 bg-gradient-to-br from-accent-50 via-white to-gray-50 rounded-2xl border border-accent-100 shadow-sm"
            >
                <div class="text-center">
                    <h3 class="text-2xl md:text-3xl font-light text-gray-900 mb-4">
                        Get More Insights Like This
                    </h3>
                    <p class="text-gray-600 mb-8 max-w-md mx-auto text-lg">
                        Join bootstrapped founders getting practical insights every week.
                    </p>
                    <a
                        href="/newsletter"
                        class="inline-flex items-center px-8 py-3.5 bg-accent-600 text-white font-medium rounded-full hover:bg-accent-700 transition-all hover:shadow-lg text-base"
                    >
                        Subscribe to Newsletter
                    </a>
                </div>
            </div>
        </div>

        <!-- Related Posts Section -->
        {
            relatedPosts.length > 0 && (
                <section class="bg-gray-50 border-t border-gray-100 mt-20">
                    <div class="container max-w-3xl mx-auto px-6 py-16">
                        <h3 class="text-2xl font-light text-gray-900 mb-10">
                            Continue Reading
                        </h3>
                        <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
                            {relatedPosts.map((post) => (
                                <article class="group">
                                    <a
                                        href={`/writing/${post.slug}/`}
                                        class="block p-6 bg-white rounded-lg border border-gray-200 hover:border-accent-300 hover:shadow-md transition-all"
                                    >
                                        <time class="text-xs font-medium text-accent-600 uppercase tracking-wider">
                                            {formatDate(post.data.date)}
                                        </time>
                                        <h4 class="text-lg font-medium text-gray-900 mt-3 mb-2 group-hover:text-accent-600 transition-colors line-clamp-2">
                                            {post.data.title}
                                        </h4>
                                        {post.data.summary && (
                                            <p class="text-sm text-gray-600 line-clamp-3">
                                                {post.data.summary}
                                            </p>
                                        )}
                                    </a>
                                </article>
                            ))}
                        </div>
                    </div>
                </section>
            )
        }
    </article>
</BaseLayout>

<style>
    .article-content :global(h1) {
        display: none;
    }

    .article-content :global(p:first-of-type) {
        font-size: 1.25rem;
        line-height: 1.625;
        color: var(--color-gray-600);
        margin-bottom: 2rem;
    }

    .article-content :global(p) {
        font-size: 1.125rem;
        line-height: 1.75;
        color: var(--color-gray-700);
        margin-bottom: 1.75rem;
    }

    .article-content :global(h2) {
        font-size: 1.875rem;
        font-weight: 500;
        color: var(--color-gray-900);
        margin-top: 4rem;
        margin-bottom: 1.5rem;
        line-height: 1.25;
    }

    .article-content :global(h3) {
        font-size: 1.5rem;
        font-weight: 500;
        color: var(--color-gray-900);
        margin-top: 3rem;
        margin-bottom: 1rem;
        line-height: 1.375;
    }

    .article-content :global(a) {
        color: var(--color-accent-600);
        text-decoration: underline;
        text-underline-offset: 2px;
    }

    .article-content :global(a:hover) {
        color: var(--color-accent-700);
    }

    .article-content :global(strong) {
        font-weight: 600;
        color: var(--color-gray-900);
    }

    .article-content :global(em) {
        font-style: italic;
        color: var(--color-gray-800);
    }

    .article-content :global(ul) {
        color: var(--color-gray-700);
        margin: 1.5rem 0;
        padding-left: 0;
        list-style: none;
    }

    .article-content :global(ul li) {
        margin: 0.75rem 0;
        line-height: 1.625;
        padding-left: 1.5rem;
        position: relative;
    }

    .article-content :global(ul li::before) {
        content: "â€“";
        position: absolute;
        left: 0;
        color: var(--color-gray-500);
        font-weight: 500;
    }

    .article-content :global(ol) {
        color: var(--color-gray-700);
        margin: 1.5rem 0;
        padding-left: 2rem;
        list-style: decimal;
        list-style-position: outside;
    }

    .article-content :global(ol li) {
        margin: 0.75rem 0;
        line-height: 1.625;
        padding-left: 0.5rem;
    }

    .article-content :global(blockquote) {
        border-left: 4px solid var(--color-accent-500);
        padding-left: 1.5rem;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        margin: 2rem 0;
        font-style: italic;
        color: var(--color-gray-700);
    }

    .article-content :global(code) {
        color: var(--color-accent-700);
        background-color: var(--color-gray-100);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-family: ui-monospace, SFMono-Regular, 'SF Mono', Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
        font-size: 0.875rem;
    }

    .article-content :global(pre) {
        background-color: var(--color-gray-900);
        color: var(--color-gray-100);
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin: 2rem 0;
        overflow-x: auto;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .article-content :global(pre code) {
        background: transparent;
        color: inherit;
        padding: 0;
    }

    .article-content :global(hr) {
        border: none;
        border-top: 2px solid var(--color-gray-200);
        margin: 3rem 0;
    }

    .article-content :global(img) {
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        margin: 2.5rem 0;
    }

    @media (min-width: 768px) {
        .article-content :global(h2) {
            font-size: 2.25rem;
        }
        
        .article-content :global(h3) {
            font-size: 1.875rem;
        }
    }
</style>
